name: OnePlus Pad Pro Ultimate (Bazel Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Manifest
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync

      - name: Config Git
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "Bot"
          git config --global --add safe.directory "*"

      - name: Repo Init and Sync
        run: |
          mkdir workspace && cd workspace
          repo init -u "file://$GITHUB_WORKSPACE" -m Oneplus_pad_Pro.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      # --- 核心魔改注入 ---
      - name: Kernel Core Modding
        run: |
          cd workspace/kernel_platform/common
          # 1. 跨核抢占加速
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c 2>/dev/null || true
          # 2. 渲染进程实时优先级
          sed -i '/SCHED_NORMAL/a \	if (p->comm && strstr(p->comm, "RenderThread")) p->policy = SCHED_FIFO;' kernel/sched/core.c 2>/dev/null || true
          # 3. MGLRU 开启
          echo "CONFIG_LRU_GEN=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LRU_GEN_ENABLED=y" >> arch/arm64/configs/gki_defconfig
          # 4. BBR 拥塞控制
          echo 'CONFIG_TCP_CONG_BBR=y' >> arch/arm64/configs/gki_defconfig
          echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> arch/arm64/configs/gki_defconfig

      - name: Vendor Config Tuning
        run: |
          cd workspace/kernel_platform/msm-kernel
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=.*/CONFIG_SYSTEM_TRUSTED_KEYS=""/g' {} +
          for cfg in arch/arm64/configs/vendor/pineapple_GKI.config arch/arm64/configs/vendor/sm8650_defconfig; do
            [ -f "$cfg" ] && echo "CONFIG_HZ_300=y" >> "$cfg" && echo "CONFIG_SLUB_DEBUG=n" >> "$cfg"
          done

      - name: Run Build Script
        run: |
          cd workspace
          # 强制清理部分旧产物，确保 Bazel 重新评估修改
          find kernel_platform/out -name "Image" -delete 2>/dev/null || true
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      # --- 修复版打包逻辑 ---
      - name: Pack AnyKernel3
        if: success()
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          
          # 核心修复：追踪软链接的真实二进制文件
          echo "正在全盘搜索真正的 Image..."
          IMAGE_SRC=$(find kernel_platform/out -name Image -type l -o -type f | head -n 1)
          
          if [ -z "$IMAGE_SRC" ]; then
            echo "错误：未发现 Image 产物，编译可能失败！"
            exit 1
          fi
          
          DIST_DIR=$(dirname "$IMAGE_SRC")
          echo "产物目录定位成功: $DIST_DIR"
          
          cd AK3
          # -L 参数非常关键，它会把链接指向的真实文件拷贝进来
          cp -L "../$IMAGE_SRC" .
          find "../$DIST_DIR" -name "dtbo.img" -exec cp -L {} . \;
          find "../$DIST_DIR" -name "*.ko" -exec cp -L {} . \;
          
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../../OnePlus_Pad_Pro_Ultimate.zip *

      - name: Create Magisk Addon
        if: success()
        run: |
          mkdir -p Addon && cd Addon
          echo -e "id=phantom_opt\nname=Phantom Optimizer\nversion=v1.0\nauthor=Gemini\ndescription=Activate Kernel Black-Tech." > module.prop
          echo -e "#!/system/bin/sh\nuntil [ \"\$(getprop sys.boot_completed)\" = \"1\" ]; do sleep 10; done\necho y > /sys/kernel/mm/lru_gen/enabled\necho ssg > /sys/block/sda/queue/scheduler\nsysctl -w net.ipv4.tcp_congestion_control=bbr" > service.sh
          zip -r ../OnePlus_Pad_Pro_Magisk_Addon.zip *

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Pad_Pro_Bundle
          path: |
            OnePlus_Pad_Pro_Ultimate.zip
            OnePlus_Pad_Pro_Magisk_Addon.zip