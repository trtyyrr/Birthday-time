name: OnePlus Pad Pro Ultimate Pure Tuned Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Manifest
        uses: actions/checkout@v4
        with:
          path: main_repo

      # --- 第一步：环境深度净化 (为 8 Gen 3 编译腾出空间) ---
      - name: Pure Environment Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo apt clean
          docker rmi $(docker images -q) 2>/dev/null || true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync

      - name: Config Git
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "Bot"
          git config --global --add safe.directory "*"

      # --- 第二步：标准源码同步 (基于你的清单文件) ---
      - name: Repo Init & Sync
        run: |
          mkdir workspace && cd workspace
          cp ../main_repo/Oneplus_pad_Pro.xml .
          # 初始化并同步。注意： depth=1 减少下载量，加快速度
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -m Oneplus_pad_Pro.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      # --- 第三步：深度内核手术 (调度器与 I/O 调校) ---
      - name: Kernel Core Surgical Modding
        run: |
          cd workspace/kernel_platform/common
          
          # 1. CPU 调度：注入强制抢占 (Low Latency Core)
          # 将 Resched 逻辑从普通唤醒提升为强制抢占，解决高负载下的掉帧
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c 2>/dev/null || true
          
          # 2. 线程提速：渲染线程置顶 (RenderThread RT)
          # 在内核调度器中直接识别渲染进程，赋予其实时优先级，无需任何外部模块
          sed -i '/SCHED_NORMAL/a \	if (p->comm && strstr(p->comm, "RenderThread")) p->policy = SCHED_FIFO;' kernel/sched/core.c 2>/dev/null || true

          # 3. I/O 革命：重构 UFS 4.0 读写逻辑
          # 将 MQ-Deadline 的读过期时间从 500ms 压缩至 100ms，大幅提升 App 加载和游戏转场速度
          sed -i 's/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (500 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_READ_EXPIRE (100 \* HZ \/ 1000)/g' block/mq-deadline.c 2>/dev/null || true
          # 提升写请求优先级，防止后台同步数据时拖慢前台操作
          sed -i 's/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (5000 \* HZ \/ 1000)/#define MQ_DEADLINE_DEFAULT_WRITE_EXPIRE (1000 \* HZ \/ 1000)/g' block/mq-deadline.c 2>/dev/null || true

          # 4. 内存黑科技：MGLRU + BBR
          echo "CONFIG_LRU_GEN=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LRU_GEN_ENABLED=y" >> arch/arm64/configs/gki_defconfig
          echo 'CONFIG_TCP_CONG_BBR=y' >> arch/arm64/configs/gki_defconfig
          echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> arch/arm64/configs/gki_defconfig

      # --- 第四步：厂商配置去冗余 (待机续航核心) ---
      - name: Vendor Config Debloating
        run: |
          cd workspace/kernel_platform/msm-kernel
          # 彻底禁用冗余的内核追踪和调试 (减少 CPU 无谓消耗，降低功耗)
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_DEBUG_KERNEL=y/CONFIG_DEBUG_KERNEL=n/g' {} +
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_FTRACE=y/CONFIG_FTRACE=n/g' {} +
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_STACKTRACE=y/CONFIG_STACKTRACE=n/g' {} +
          
          # 注入一加平板 Pro 专属优化
          for cfg in arch/arm64/configs/vendor/pineapple_GKI.config arch/arm64/configs/vendor/sm8650_defconfig; do
            if [ -f "$cfg" ]; then
              echo "CONFIG_HZ_300=y" >> "$cfg"       # 动态刷新率调度优化
              echo "CONFIG_SLUB_DEBUG=n" >> "$cfg"   # 极速内存分配
              echo "CONFIG_ENERGY_MODEL=y" >> "$cfg" # 开启能效模型，让 CPU 选核更智能
            fi
          done

      # --- 第五步：Bazel 编译流程 (拒绝缓存) ---
      - name: Real Kernel Compilation
        run: |
          cd workspace
          rm -rf kernel_platform/out # 确保完全重新编译
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # 调用官方脚本编译 Pineapple (8 Gen 3)
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      # --- 第六步：产物捕获与 AnyKernel3 打包 ---
      - name: Pack Pure Kernel
        if: success()
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          
          # 解决软链接问题的核心：使用 -L 寻找物理文件
          IMAGE_PATH=$(find kernel_platform/out/dist -name Image -type l -o -type f | head -n 1)
          DIST_DIR=$(dirname "$IMAGE_PATH")
          
          cd AK3
          cp -L "$IMAGE_PATH" .
          find "$DIST_DIR" -name "dtbo.img" -exec cp -L {} . \;
          find "$DIST_DIR" -name "vendor_boot.img" -exec cp -L {} . \;
          # 搜集所有编译生成的驱动模块 (.ko)
          find "$DIST_DIR" -name "*.ko" -exec cp -L {} . \;
          
          # 设备适配修改
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          
          zip -r9 ../../OnePlus_Pad_Pro_Pure_Ultimate.zip *

      - name: Upload Finished Kernel
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Pure_Tuned_Kernel
          path: OnePlus_Pad_Pro_Pure_Ultimate.zip