name: OnePlus Pad Pro Kernel (Pineapple) with AK3 Pack

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      # 1. 检出清单仓库
      - name: Checkout Manifest
        uses: actions/checkout@v4

      # 2. 深度清理磁盘空间 (防止 8gen3 源码爆磁盘)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap: true

      # 3. 安装依赖项
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync

      # 4. 配置 Git
      - name: Config Git
        run: |
          git config --global user.email "kernel-bot@example.com"
          git config --global user.name "Kernel-Bot"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "*"

      # 5. 初始化并同步源码 (修复 file:// 协议)
      - name: Repo Init and Sync
        run: |
          mkdir workspace && cd workspace
          repo init -u "file://$GITHUB_WORKSPACE" -m Oneplus_pad_Pro.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      # 6. 修复内核签名配置
      - name: Patch Config
        run: |
          cd workspace/kernel_platform/msm-kernel
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=.*/CONFIG_SYSTEM_TRUSTED_KEYS=""/g' {} +
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_REVOCATION_KEYS=.*/CONFIG_SYSTEM_REVOCATION_KEYS=""/g' {} +

      # 7. 执行编译脚本
      - name: Run Build Script
        run: |
          cd workspace
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      # 8. 打包成 AnyKernel3
      - name: Pack with AnyKernel3
        run: |
          cd workspace
          # 下载 AnyKernel3 模板
          git clone https://github.com/osm0sis/AnyKernel3.git AK3
          cd AK3
          
          # 定义产物路径 (根据高通构建习惯)
          DIST_PATH="../out/device/qcom/pineapple/dist"
          
          # 1. 复制内核镜像
          if [ -f "$DIST_PATH/Image" ]; then
            cp "$DIST_PATH/Image" .
          fi
          
          # 2. 复制 DTBO 镜像 (如果存在)
          if [ -f "$DIST_PATH/dtbo.img" ]; then
            cp "$DIST_PATH/dtbo.img" .
          fi

          # 3. 复制驱动模块 (.ko 文件)
          mkdir -p modules/vendor/lib/modules
          find "$DIST_PATH" -name "*.ko" -exec cp {} modules/vendor/lib/modules/ \;
          
          # 4. 简单修改 anykernel.sh (根据设备名简单调整)
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          sed -i 's/device.name2=.*/device.name2=OP592L1/g' anykernel.sh # 这里可以按需修改
          
          # 5. 压缩成 zip
          zip -r9 ../../OnePlus_Pad_Pro_AK3.zip * -x .git* README.md *placeholder

      # 9. 上传 AK3 压缩包产物
      - name: Upload AK3 Zip
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Pad_Pro_AK3_Kernel
          path: OnePlus_Pad_Pro_AK3.zip