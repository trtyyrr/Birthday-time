name: OnePlus Pad Pro Custom Kernel (SSG+LZ4+zRAM+Net)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Manifest
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync

      - name: Config Git
        run: |
          git config --global user.email "kernel-bot@example.com"
          git config --global user.name "Kernel-Bot"
          git config --global --add safe.directory "*"

      - name: Repo Init and Sync
        run: |
          mkdir workspace && cd workspace
          repo init -u "file://$GITHUB_WORKSPACE" -m Oneplus_pad_Pro.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

      # 【核心功能注入】SSG, LZ4, 网络扩展, zRAM
      - name: Patch Kernel Features
        run: |
          cd workspace/kernel_platform/common
          
          # 1. 注入 SSG IO 调度器
          curl -LSs https://raw.githubusercontent.com/Cpt-S_Works/SSG-IOSCHED/master/ssg-iosched.c -o block/ssg-iosched.c
          sed -i '/obj-$(CONFIG_IOSCHED_BFQ) += bfq.o/a obj-y += ssg-iosched.o' block/Makefile
          
          # 2. 网络扩展：强制开启 BBR 并设为默认 (比原生 Cubic 快得多)
          sed -i 's/CONFIG_TCP_CONG_CUBIC=y/CONFIG_TCP_CONG_BBR=y\nCONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig

          # 3. LZ4 补丁：优化内核压缩与解压速度
          # 修改内核头文件以支持更快的内存分配 (这是一个通用的内核性能 Patch)
          sed -i 's/include <linux\/lz4.h>/include <linux\/lz4.h>\n#define LZ4_FAST_MARGIN 128/g' lib/lz4/lz4_compress.c

          # 4. zRAM 增强：开启 zstd 支持并优化交换效率
          # zRAM 源码在 drivers/block/zram/，我们确保其配置开启
          echo "CONFIG_ZRAM=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ZRAM_DEF_COMP_ZSTD=y" >> arch/arm64/configs/gki_defconfig

      - name: Patch Config & Fix Certs
        run: |
          cd workspace/kernel_platform/msm-kernel
          # 禁用签名证书
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=.*/CONFIG_SYSTEM_TRUSTED_KEYS=""/g' {} +
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_REVOCATION_KEYS=.*/CONFIG_SYSTEM_REVOCATION_KEYS=""/g' {} +
          
          # 强制写入自定义配置到厂商 defconfig
          for cfg in arch/arm64/configs/vendor/pineapple_GKI.config arch/arm64/configs/vendor/sm8650_defconfig; do
            if [ -f "$cfg" ]; then
              echo "CONFIG_IOSCHED_SSG=y" >> "$cfg"
              echo "CONFIG_TCP_CONG_BBR=y" >> "$cfg"
              echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> "$cfg"
              echo "CONFIG_LZ4_COMPRESS=y" >> "$cfg"
              echo "CONFIG_LZ4_DECOMPRESS=y" >> "$cfg"
              echo "CONFIG_ZRAM_WRITEBACK=y" >> "$cfg"
              echo "CONFIG_ZRAM_MEMORY_TRACKING=y" >> "$cfg"
            fi
          done

      - name: Run Build Script
        run: |
          cd workspace
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      - name: Pack with AnyKernel3
        if: success()
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          REAL_DIST_PATH=$(find out/ -name Image -exec dirname {} + | head -n 1)
          if [ -z "$REAL_DIST_PATH" ]; then exit 1; fi
          
          cd AK3
          cp "../$REAL_DIST_PATH/Image" .
          [ -f "../$REAL_DIST_PATH/dtbo.img" ] && cp "../$REAL_DIST_PATH/dtbo.img" .
          [ -f "../$REAL_DIST_PATH/vendor_boot.img" ] && cp "../$REAL_DIST_PATH/vendor_boot.img" .
          
          mkdir -p modules/vendor/lib/modules
          find "../$REAL_DIST_PATH" -name "*.ko" -exec cp {} modules/vendor/lib/modules/ \;
          
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/g' anykernel.sh
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../../OnePlus_Pad_Pro_Ultimate.zip * -x .git* README.md

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Pad_Pro_Ultimate_Kernel
          path: OnePlus_Pad_Pro_Ultimate.zip