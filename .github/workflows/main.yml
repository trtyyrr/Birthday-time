name: OnePlus Pad Pro Kernel Build (Pineapple)

on:
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      # 1. 深度清理磁盘空间（8 Gen 3 编译必须，否则必爆磁盘）
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap: true

      # 2. 安装内核编译基础依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip

      # 3. 配置 Git 环境
      - name: Config Git
        run: |
          git config --global user.email "kernel-bot@example.com"
          git config --global user.name "Kernel-Bot"

      # 4. 初始化并同步源码
      - name: Repo Init and Sync
        run: |
          mkdir workspace && cd workspace
          # 使用你仓库里的清单文件
          repo init -u ${{ github.workspace }} -m Oneplus_pad_Pro.xml --depth=1
          # 同步代码（-j8 适当控制并发防止内存溢出）
          repo sync -c -j8 --no-tags --no-clone-bundle

      # 5. 关键修复：禁用内核签名证书检查（防止因找不到 .pem 文件报错）
      - name: Patch Config
        run: |
          cd workspace/kernel_platform/msm-kernel
          # 遍历所有可能的配置文件并禁用签名密钥路径
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=.*/CONFIG_SYSTEM_TRUSTED_KEYS=""/g' {} +
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_REVOCATION_KEYS=.*/CONFIG_SYSTEM_REVOCATION_KEYS=""/g' {} +
          echo "Kernel config patched to bypass certificate issues."

      # 6. 执行一加官方编译脚本
      - name: Run Build Script
        run: |
          cd workspace
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          # 使用你提供的指令进行编译
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      # 7. 收集并上传产物
      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Pad_Pro_Kernel
          path: |
            workspace/out/device/qcom/pineapple/dist/Image
            workspace/out/device/qcom/pineapple/dist/*.ko
            workspace/out/device/qcom/pineapple/dist/dtbo.img
            workspace/out/device/qcom/pineapple/dist/boot.img
