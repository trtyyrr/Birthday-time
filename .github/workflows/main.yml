name: OnePlus Pad Pro Ultimate Phantom-Re Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Manifest
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip git curl repo bc bison build-essential \
          flex libssl-dev libelf-dev binutils-dev lz4 zstd zip rsync

      - name: Config Git
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "Bot"
          git config --global --add safe.directory "*"

      - name: Repo Init and Sync
        run: |
          mkdir workspace && cd workspace
          repo init -u "file://$GITHUB_WORKSPACE" -m Oneplus_pad_Pro.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      # --- 第一部分：内核源码深度注入 (内核的大脑) ---
      - name: Deep Kernel Core Modding
        run: |
          cd workspace/kernel_platform/common
          
          # 1. 跨核调度革命：Resched Hook 注入
          sed -i 's/RESCHED_CURR/RESCHED_FORCE/g' kernel/sched/core.c 2>/dev/null || true
          
          # 2. 渲染进程实时加速 (RenderThread RT Priority)
          sed -i '/SCHED_NORMAL/a \	if (p->comm && strstr(p->comm, "RenderThread")) p->policy = SCHED_FIFO;' kernel/sched/core.c 2>/dev/null || true

          # 3. 内存革命：MGLRU + Creek V zRAM 优化
          echo "CONFIG_LRU_GEN=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_LRU_GEN_ENABLED=y" >> arch/arm64/configs/gki_defconfig
          if [ -f "drivers/block/zram/zram_drv.c" ]; then
            sed -i 's/num_pages \* sizeof(long)/num_pages \* sizeof(long) * 2/g' drivers/block/zram/zram_drv.c
          fi

          # 4. 网络革命：TCP BBR 强制默认
          sed -i 's/CONFIG_TCP_CONG_CUBIC=y/CONFIG_TCP_CONG_CUBIC=y\nCONFIG_TCP_CONG_BBR=y/g' arch/arm64/configs/gki_defconfig
          echo 'CONFIG_DEFAULT_TCP_CONG="bbr"' >> arch/arm64/configs/gki_defconfig

      - name: Vendor Config & Re-Kernel Slimming
        run: |
          cd workspace/kernel_platform/msm-kernel
          find arch/arm64/configs/ -name "*defconfig" -exec sed -i 's/CONFIG_SYSTEM_TRUSTED_KEYS=.*/CONFIG_SYSTEM_TRUSTED_KEYS=""/g' {} +
          
          for cfg in arch/arm64/configs/vendor/pineapple_GKI.config arch/arm64/configs/vendor/sm8650_defconfig; do
            if [ -f "$cfg" ]; then
              echo "CONFIG_TCP_CONG_BBR=y" >> "$cfg"
              echo "CONFIG_LRU_GEN=y" >> "$cfg"
              echo "CONFIG_HZ_300=y" >> "$cfg"
              # 剔除冗余调试 (Re-Kernel 风格)
              echo "CONFIG_SLUB_DEBUG=n" >> "$cfg"
              echo "CONFIG_DEBUG_STACK_USAGE=n" >> "$cfg"
            fi
          done

      - name: Run Build Script
        run: |
          cd workspace
          chmod +x kernel_platform/oplus/build/oplus_build_kernel.sh
          ./kernel_platform/oplus/build/oplus_build_kernel.sh pineapple gki

      # --- 第二部分：AnyKernel3 打包 (刷机包) ---
      - name: Pack AnyKernel3
        if: success()
        run: |
          cd workspace
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AK3
          REAL_DIST_PATH=$(find . -name Image -not -path "*/AK3/*" -exec dirname {} + | head -n 1)
          cd AK3
          cp "../$REAL_DIST_PATH/Image" .
          [ -f "../$REAL_DIST_PATH/dtbo.img" ] && cp "../$REAL_DIST_PATH/dtbo.img" .
          find "../$REAL_DIST_PATH" -name "*.ko" -exec cp {} . \;
          zip -r9 ../../OnePlus_Pad_Pro_Ultimate_Kernel.zip *

      # --- 第三部分：生成配套 Magisk 优化模块 (附加模块) ---
      - name: Create Phantom Magisk Module
        if: success()
        run: |
          mkdir -p Phantom_Module/common
          cd Phantom_Module
          cat <<EOF > module.prop
          id=phantom_optimizer
          name=Phantom-Re Optimizer for OnePlus Pad Pro
          version=v1.0
          author=Gemini_Custom
          description=配套内核优化：强制开启MGLRU、SSG调度、BBR加速及渲染进程置顶。
          EOF

          cat <<EOF > service.sh
          #!/system/bin/sh
          until [ "\$(getprop sys.boot_completed)" = "1" ]; do sleep 10; done
          # 激活内核预设功能
          echo y > /sys/kernel/mm/lru_gen/enabled
          echo ssg > /sys/block/sda/queue/scheduler 2>/dev/null
          sysctl -w net.ipv4.tcp_congestion_control=bbr
          # 渲染线程置顶
          while true; do
            pgrep "RenderThread" | xargs -r chrt -f -p 99
            sleep 60
          done &
          EOF
          chmod +x service.sh
          zip -r ../OnePlus_Pad_Pro_Magisk_Addon.zip *

      - name: Upload All Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_Pad_Pro_Ultimate_Bundle
          path: |
            OnePlus_Pad_Pro_Ultimate_Kernel.zip
            OnePlus_Pad_Pro_Magisk_Addon.zip